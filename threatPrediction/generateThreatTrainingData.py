# Software is free software released under the "GNU General Public License v3.0"
# Copyright (c) 2021 Yuning-Jiang - yuning.jiang17@gmail.com

import json
import csv
import pandas as pd
from os import listdir
from os.path import join
from sklearn.model_selection import train_test_split

def create_nvd_dict(year):
    filename = join("json/nvdcve-1.1-" + str(year) + ".json")
    #print("Opening: " + filename)
    with open(filename, encoding="utf8") as json_file:
        cve_dict = json.load(json_file)
    return(cve_dict)

def generate_threattypes():
    list = listdir("json/")
    number_files = len(list)
    for year in range(2002,2002 + number_files):
        year_in_string = str(year)
        cve_dict = create_nvd_dict(year)
        fileName = 'NVD_'+ year_in_string + '_threat_train.csv'
        with open('trainThreatData/' + fileName, 'w', newline='') as f_output:
            csv_output = csv.writer(f_output)
            csv_output.writerow(['id', 'report','memc', 'bypass', 'csrf', 'dirtra', 'dos', 'execution', 'fileinc', 'gainpre', 'httprs', 'infor', 'overflow',
            'sqli', 'xss'])

            for item in cve_dict['CVE_Items']:
                cve_id = item['cve']['CVE_data_meta']['ID']
                report = item['cve']['description']['description_data'][0]['value']
                if not report.find("REJECT"):
                    continue

                memc = 0
                bypass = 0
                csrf = 0
                dirtra = 0
                dos = 0
                execution = 0
                fileinc = 0
                gainpre = 0
                httprs = 0
                infor = 0
                overflow = 0
                sqli = 0
                xss = 0

                name_cat = ['memc', 'bypass', 'csrf', 'dirtra', 'dos', 'execution', 'fileinc', 'gainpre', 'httprs', 'infor', 'overflow','sqli', 'xss']
                threat_list = [memc, bypass, csrf, dirtra, dos, execution, fileinc, gainpre, httprs, infor, overflow, sqli, xss]
                for cat_idx in range(13):
                    fobj = open('cveIDThreatType/cve_id' + name_cat[cat_idx], 'r')
                    text = fobj.read().strip().split()
                    try:
                        s = cve_id
                        if s == "":
                            continue
                        elif s in text:
                            threat_list[cat_idx]=1
                        else:
                            threat_list[cat_idx]=0

                    except Exception as e:
                        print(e)

                memc = threat_list[0]
                bypass = threat_list[1]
                csrf = threat_list[2]
                dirtra = threat_list[3]
                dos = threat_list[4]
                execution = threat_list[5]
                fileinc = threat_list[6]
                gainpre = threat_list[7]
                httprs = threat_list[8]
                infor = threat_list[9]
                overflow = threat_list[10]
                sqli = threat_list[11]
                xss = threat_list[12]

                csv_output.writerow([cve_id, report,memc, bypass, csrf, dirtra, dos, execution, fileinc, gainpre, httprs, infor, overflow, sqli, xss])

def generate_CombinedFile():
    list = listdir("trainThreatData/")
    number_files = len(list)
    dict = []
    dict_of_reports = {}
    for year in range(2002,2002 + number_files):
        year_in_string = str(year)
        file_name = 'NVD_'+ year_in_string + '_threat_train.csv'
        dict_of_reports[year_in_string] = []
        dict_of_reports[year_in_string] = pd.read_csv("trainThreatData/" + file_name)
        dict.append(dict_of_reports[year_in_string])
    df = pd.concat(dict, ignore_index=True)
    df = df[~df['report'].str.contains('REJECT')]
    rowsums=df.iloc[:,2:].sum(axis=1)
    x=rowsums.value_counts()
    df['clean']=(rowsums==0)
    indexNames = df[ df['clean'] == True].index
    # Delete these row indexes from dataFrame
    df.drop(indexNames, inplace=True)
    df.drop('clean', inplace=True, axis=1)
    return df

def divideTrainAndTestData(df):
    training_data, testing_data = train_test_split(df,random_state = 2000,test_size=0.25)
    testingWithLables_data = testing_data.drop('report', 1)
    testing_data2 = testing_data.drop(['memc', 'bypass', 'csrf', 'dirtra', 'dos', 'execution', 'fileinc', 'gainpre', 'httprs', 'infor', 'overflow',
            'sqli', 'xss'], 1)
    training_data.to_csv('trainTestThreatData/train.csv', encoding='utf-8', index=False)
    testing_data2.to_csv('trainTestThreatData/test.csv', encoding='utf-8', index=False)
    testingWithLables_data.to_csv('trainTestThreatData/test_labels.csv', encoding='utf-8', index=False)
    testingWithLables_data.to_csv('trainTestThreatData/submission.csv', encoding='utf-8', index=False)
    print("Number of training vulnerability reports,columns=",training_data.shape)
    print("Number of testing vulnerability reports,columns=",testing_data.shape)



